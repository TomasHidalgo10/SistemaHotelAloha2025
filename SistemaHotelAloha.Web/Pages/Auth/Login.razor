@page "/auth/login"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@using SistemaHotelAloha.Web.Auth
@inject SimpleAuthStateProvider Auth
@inject NavigationManager Nav
@inject IJSRuntime JS

<h3>Login</h3>

<div class="card" style="max-width:480px">
    <div class="card-body">
        <div class="mb-3">
            <label class="form-label">Email</label>
            <input class="form-control" @bind="_email" type="email" autocomplete="username" />
        </div>
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input class="form-control" @bind="_pass" type="password" autocomplete="current-password" />
        </div>
        <button class="btn btn-primary w-100" @onclick="DoLogin" disabled="@_loading">
            @(_loading ? "Ingresando..." : "Ingresar")
        </button>
        <div class="mt-3">
            <NavLink href="/auth/register">¿No tenés cuenta? Registrate</NavLink>
        </div>
    </div>
</div>

@code {
    private string _email = "";
    private string _pass = "";
    private bool _loading;

    private async Task DoLogin()
    {
        if (string.IsNullOrWhiteSpace(_email) || string.IsNullOrWhiteSpace(_pass))
        {
            await JS.InvokeVoidAsync("alert", "Completá email y contraseña");
            return;
        }

        try
        {
            _loading = true;
            await Auth.SignInAsync(userId: 1, name: _email.Split('@')[0], email: _email, role: "User");
            Nav.NavigateTo("/", forceLoad: false);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Login] {ex}");
            await JS.InvokeVoidAsync("alert", "No se pudo iniciar sesión.");
        }
        finally
        {
            _loading = false;
        }
    }
}
