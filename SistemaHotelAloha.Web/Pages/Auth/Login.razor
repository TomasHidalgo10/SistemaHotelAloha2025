@page "/login"
@page "/auth/login"
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Web
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Nav
@inject SistemaHotelAloha.Web.Auth.SimpleAuthStateProvider Auth

<h3 class="text-light mb-3">Iniciar sesión</h3>

<div class="card bg-dark text-light shadow p-4" style="max-width:420px">
    <EditForm Model="@_model" OnValidSubmit="HandleLogin">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Email</label>
            <InputText class="form-control" @bind-Value="_model.Email" />
            <ValidationMessage For="@(() => _model.Email)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Contraseña</label>
            <InputText class="form-control" @bind-Value="_model.Password" type="password" @onkeydown="OnKeyDown" />
            <ValidationMessage For="@(() => _model.Password)" />
        </div>

        <button class="btn btn-primary w-100" type="submit" disabled="@_loading">
            @if (_loading)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            Ingresar
        </button>

        @if (!string.IsNullOrWhiteSpace(_mensaje))
        {
            <div class="alert alert-warning mt-3">@_mensaje</div>
        }
    </EditForm>
</div>

@code {
    private LoginModel _model = new();
    private string? _mensaje;
    private bool _loading;

    private async Task HandleLogin()
    {
        if (_loading) return;
        _mensaje = null;

        _loading = true;
        try
        {
            var ok = await Auth.LoginAsync(_model.Email, _model.Password);
            if (!ok)
            {
                _mensaje = "Credenciales inválidas.";
                return;
            }

            // volver al returnUrl si vino en la query
            var uri = Nav.ToAbsoluteUri(Nav.Uri);
            var q = QueryHelpers.ParseQuery(uri.Query);
            if (q.TryGetValue("returnUrl", out var ret) && !string.IsNullOrWhiteSpace(ret))
                Nav.NavigateTo(ret!, forceLoad: true);
            else
                Nav.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            _mensaje = "Error al iniciar sesión: " + ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await HandleLogin();
    }

    private class LoginModel
    {
        [Required, EmailAddress(ErrorMessage = "Email inválido")]
        public string Email { get; set; } = "";

        [Required]
        public string Password { get; set; } = "";
    }
}
