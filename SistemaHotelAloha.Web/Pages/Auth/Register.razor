@page "/auth/register"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]

@using SistemaHotelAloha.AccesoDatos
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@inject NavigationManager Nav

@* Si preferís inyectar el repo, registralo en Program.cs y descomentá:
   builder.Services.AddScoped<UsuarioAdoRepository>();
   @inject UsuarioAdoRepository Usuarios *@

<div class="container py-4">
    <div class="card p-4 mx-auto" style="max-width: 620px;">
        <h3 class="mb-3">Crear cuenta</h3>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="alert alert-danger">@_error</div>
        }

        @if (!string.IsNullOrWhiteSpace(_ok))
        {
            <div class="alert alert-success">@_ok</div>
        }

        <EditForm Model="_vm" OnValidSubmit="OnSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Nombre</label>
                    <InputText class="form-control" @bind-Value="_vm.Nombre" />
                    <ValidationMessage For="@(() => _vm.Nombre)" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <InputText class="form-control" autocomplete="email" @bind-Value="_vm.Email" />
                    <ValidationMessage For="@(() => _vm.Email)" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Contraseña</label>
                    <InputText type="password" class="form-control" autocomplete="new-password" @bind-Value="_vm.Password" />
                    <ValidationMessage For="@(() => _vm.Password)" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Repetir contraseña</label>
                    <InputText type="password" class="form-control" autocomplete="new-password" @bind-Value="_vm.ConfirmPassword" />
                    <ValidationMessage For="@(() => _vm.ConfirmPassword)" />
                </div>
            </div>

            <button class="btn btn-success w-100 mt-3" disabled="@_busy">
                @(_busy ? "Creando cuenta..." : "Registrarme")
            </button>
        </EditForm>

        <div class="text-center mt-3">
            <NavLink href="/auth/login">¿Ya tenés cuenta? Iniciá sesión</NavLink>
        </div>
    </div>
</div>

@code {
    private readonly RegisterVM _vm = new();
    private bool _busy;
    private string? _error;
    private string? _ok;

    private async Task OnSubmit()
    {
        _error = _ok = null;
        _busy = true;

        try
        {
            // ============================
            // 1) Crear usuario (ADO.NET)
            // ============================
            // Opción A: repo inyectado
            // var repo = Usuarios;

            // Opción B: instanciar directo (usa tu MySqlConnectionFactory internamente)
            var repo = new UsuarioAdoRepository();

            var nuevoId = repo.Create(
                nombre: _vm.Nombre,
                apellido: null!,                // opcional
                email: _vm.Email,
                contraseña: _vm.Password,      // si luego querés hash, cámbialo aquí
                telefono: null!,                // opcional
                fechaRegistro: DateTime.UtcNow,
                activo: true
            );

            if (nuevoId == -1062)
            {
                _error = "Ese email ya está registrado.";
                return;
            }
            if (nuevoId <= 0)
            {
                _error = "No se pudo crear la cuenta (error desconocido).";
                return;
            }

            // ============================
            // 2) Avisar y redirigir
            // ============================
            _ok = "Cuenta creada correctamente. Te redirigimos al login…";
            await Task.Delay(900);
            Nav.NavigateTo("/auth/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            _error = "No se pudo crear la cuenta. " + ex.Message;
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }

    public class RegisterVM
    {
        [Required(ErrorMessage = "Ingresá tu nombre")]
        [StringLength(80, MinimumLength = 2)]
        public string Nombre { get; set; } = string.Empty;

        [Required(ErrorMessage = "Ingresá tu email")]
        [EmailAddress(ErrorMessage = "Formato de email inválido")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Ingresá una contraseña")]
        [StringLength(64, MinimumLength = 6, ErrorMessage = "La contraseña debe tener al menos 6 caracteres")]
        public string Password { get; set; } = string.Empty;

        [Required]
        [Compare(nameof(Password), ErrorMessage = "Las contraseñas no coinciden")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
