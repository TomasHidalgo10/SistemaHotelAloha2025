@page "/habitaciones"
@inject SistemaHotelAloha.AccesoDatos.ReservasAdoRepository Repo
@inject NavigationManager Nav
@inject AuthenticationStateProvider Auth
@inject IJSRuntime JS

<h3>Buscar habitaciones</h3>

<div class="card bg-dark text-light p-3 mb-3">
    <div class="row g-2 align-items-end">
        <div class="col-md-4">
            <label class="form-label">Tipo de habitación</label>
            <select class="form-select" @bind="_tipoId">
                <option value="0">-- Seleccionar --</option>
                @foreach (var t in _tipos)
                {
                    <option value="@t.Id">@t.Nombre</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Fecha desde</label>
            <input class="form-control" type="date" @bind="_desde" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Fecha hasta</label>
            <input class="form-control" type="date" @bind="_hasta" />
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-primary" @onclick="Buscar">Buscar</button>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert alert-warning mt-3">@_error</div>
    }
</div>

@if (_loading)
{
    <div class="text-center"><div class="spinner-border"></div></div>
}
else if (_result is not null && _result.Count == 0)
{
    <div class="alert alert-info">No hay habitaciones disponibles para ese rango.</div>
}
else if (_result is not null)
{
    <div class="row row-cols-1 row-cols-md-3 g-3">
        @foreach (var h in _result)
        {
            <div class="col">
                <div class="card h-100 shadow-sm">
                    @if (!string.IsNullOrWhiteSpace(h.Foto))
                    {
                        <img src="@h.Foto" class="card-img-top" style="height:180px;object-fit:cover"
                             onerror="this.style.display='none'">
                    }
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@h.Tipo - Nº @h.Numero</h5>
                        @if (!string.IsNullOrWhiteSpace(h.Descripcion))
                        {
                            <p class="text-muted mb-2">@h.Descripcion</p>
                        }
                        <p class="mb-3"><strong>Precio/noche:</strong> @h.Precio.ToString("C")</p>
                        <button class="btn btn-success mt-auto" @onclick="() => Reservar(h.Id)">Reservar</button>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<SistemaHotelAloha.AccesoDatos.ReservasAdoRepository.TipoHabDto> _tipos = new();
    private List<SistemaHotelAloha.AccesoDatos.ReservasAdoRepository.HabitacionDispDto>? _result;

    private int _tipoId;
    private DateTime _desde = DateTime.Today;
    private DateTime _hasta = DateTime.Today.AddDays(1);

    private bool _loading;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        _tipos = await Repo.ObtenerTiposHabitacionAsync();
    }

    private async Task Buscar()
    {
        _error = null;
        _result = null;

        if (_tipoId <= 0) { _error = "Elegí un tipo de habitación."; return; }
        if (_hasta <= _desde) { _error = "La fecha hasta debe ser mayor a la fecha desde."; return; }

        _loading = true;
        try
        {
            _result = await Repo.BuscarDisponiblesPorTipoAsync(_tipoId, _desde, _hasta);
        }
        catch (Exception ex)
        {
            _error = "Error al buscar: " + ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Reservar(int idHabitacion)
    {
        try
        {
            // 1) Validaciones básicas
            if (_hasta <= _desde)
                throw new Exception("La fecha hasta debe ser mayor a la fecha desde.");

            // 2) Login requerido
            var state = await Auth.GetAuthenticationStateAsync();
            var user = state.User;
            var isAuth = user.Identity?.IsAuthenticated ?? false;
            if (!isAuth)
            {
                var returnUrl =
                    $"/habitaciones?tipo={_tipoId}&desde={_desde:yyyy-MM-dd}&hasta={_hasta:yyyy-MM-dd}";
                Nav.NavigateTo($"/login?returnUrl={Uri.EscapeDataString(returnUrl)}");
                return;
            }

            // 3) Usuario actual
            var idStr = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrWhiteSpace(idStr) || !int.TryParse(idStr, out var idUsuario))
                throw new Exception("No se pudo determinar el usuario actual.");

            // 4) Verificar disponibilidad por si entre la búsqueda y el click se ocupó
            var libre = await Repo.HabitacionDisponibleAsync(idHabitacion, _desde, _hasta);
            if (!libre) throw new Exception("La habitación ya no está disponible para ese rango.");

            // 5) Asegurar cliente para el usuario (si no existe, se crea en blanco)
            var idCliente = await Repo.AsegurarClienteParaUsuarioAsync(idUsuario);

            // 6) Crear reserva
            var idReserva = await Repo.CrearReserva(idUsuario, idCliente, idHabitacion, _desde, _hasta);

            // 7) Abrir PDF (mismo tab, fuerza recarga del endpoint)
            Nav.NavigateTo($"/pdf/reserva/{idReserva}", forceLoad: true);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Error al reservar: " + ex.Message);
        }
    }
}
