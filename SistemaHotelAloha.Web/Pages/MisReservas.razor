@page "/mis-reservas"
@inject SistemaHotelAloha.AccesoDatos.ReservasAdoRepository Repo
@inject AuthenticationStateProvider Auth

<h3>Mis reservas</h3>

@if (_cargando)
{
    <div class="text-center py-4"><div class="spinner-border"></div></div>
}
else if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-warning">@_error</div>
}
else if (_items is null || _items.Count == 0)
{
    <div class="alert alert-info">No tenés reservas.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Habitación</th>
                    <th>Desde</th>
                    <th>Hasta</th>
                    <th>Total</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in _items)
                {
                    <tr>
                        <td>@r.Id</td>
                        <td>@r.Habitacion</td>
                        <td>@r.FechaDesde:dd/MM/yyyy</td>
                        <td>@r.FechaHasta:dd/MM/yyyy</td>
                        <td>@r.Total.ToString("C")</td>
                        <td><span class="badge bg-secondary">@r.Estado</span></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private bool _cargando;
    private string? _error;

    // DTO correcto: ReservasListaDto
    private List<SistemaHotelAloha.AccesoDatos.ReservasAdoRepository.ReservasListaDto>? _items;

    protected override async Task OnInitializedAsync()
    {
        _cargando = true;
        try
        {
            var state = await Auth.GetAuthenticationStateAsync();
            var user = state.User;
            if (!(user.Identity?.IsAuthenticated ?? false))
            {
                _error = "Tenés que iniciar sesión para ver tus reservas.";
                return;
            }

            var idStr = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrWhiteSpace(idStr) || !int.TryParse(idStr, out var idUsuario))
            {
                _error = "No se pudo determinar el usuario.";
                return;
            }

            _items = await Repo.ListarReservasDelUsuario(idUsuario);
        }
        catch (Exception ex)
        {
            _error = "Error al cargar: " + ex.Message;
        }
        finally
        {
            _cargando = false;
        }
    }
}
